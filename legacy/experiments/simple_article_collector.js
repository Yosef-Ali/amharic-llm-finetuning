#!/usr/bin/env node

const https = require('https');
const http = require('http');
const fs = require('fs').promises;
const path = require('path');
const { URL } = require('url');

class SimpleAmharicCollector {
  constructor() {
    this.articles = [];
    this.outputDir = './collected_articles';
    this.maxArticles = 1000;
    this.currentCount = 0;
    
    // RSS/API endpoints for Amharic content
    this.sources = [
      {
        name: 'BBC Amharic RSS',
        url: 'https://feeds.bbci.co.uk/amharic/rss.xml',
        type: 'rss'
      },
      {
        name: 'VOA Amharic RSS',
        url: 'https://www.voanews.com/api/epiqq',
        type: 'api'
      },
      {
        name: 'DW Amharic RSS',
        url: 'https://rss.cnn.com/rss/edition.rss',
        type: 'rss'
      }
    ];

    // Wikipedia Amharic articles - known good content
    this.wikiArticles = [
      '·ä¢·âµ·ãÆ·åµ·ã´', '·ä†·ã≤·àµ_·ä†·â†·â£', '·àÄ·ã≠·àà_·à•·àã·à¥', '·àò·äï·àä·ä≠_·ã≥·åç·àõ·ãä', '·âÖ·à≠·å∫_·àù·àÖ·à®·âµ', 
      '·ã®·ä¢·âµ·ãÆ·åµ·ã´_·â≥·à™·ä≠', '·ä†·àõ·à≠·äõ', '·ä¶·àÆ·àû', '·âµ·åç·à®', '·ãà·àã·ã≠·â≥', '·à≤·ã≥·àõ',
      '·ã®·ä¢·âµ·ãÆ·åµ·ã´_·â£·àï·àã·ãä_·àô·ãö·âÉ', '·ä•·äï·åÄ·à´', '·ã∂·àÆ_·ãà·å•', '·â°·äì', '·ã®·ä¢·âµ·ãÆ·åµ·ã´_·ä¶·à≠·â∂·ã∂·ä≠·àµ_·â∞·ãã·àï·ã∂_·â§·â∞_·ä≠·à≠·àµ·â≤·ã´·äï',
      '·ã®·ä†·ä≠·à±·àù_·ä¶·â§·àä·àµ·ä≠', '·àã·àä·â†·àã', '·åé·äï·ã∞·à≠', '·àÉ·à®·à≠', '·â£·àÖ·à≠_·ã≥·à≠', '·àò·âÄ·àå', '·åÖ·àõ',
      '·ä†·çã·à≠', '·à∂·àõ·àå', '·â§·äï·àª·äï·åâ·àç', '·åã·àù·â§·àã', '·ã®·ã∞·â°·â•_·â•·àî·à≠_·â•·àî·à®·à∞·â¶·âΩ',
      '·ã®·ä¢·âµ·ãÆ·åµ·ã´_·åÇ·ä¶·åç·à´·çä', '·à™·çç·âµ_·â´·àä', '·à∞·àú·äï_·â∞·à´·àÆ·âΩ', '·ä†·â£·ã≠_·ãà·äï·ãù', '·ä†·ãã·àΩ_·ãà·äï·ãù',
      '·ã®·ä¢·âµ·ãÆ·åµ·ã´_·ä¢·äÆ·äñ·àö', '·â°·äì_·àù·à≠·âµ', '·ãï·à≠·àª', '·ä•·äï·àµ·à≥·âµ_·ä†·à≠·â£', '·ä¢·äï·ã±·àµ·âµ·à™',
      '·ã®·ä¢·âµ·ãÆ·åµ·ã´_·âµ·àù·àÖ·à≠·âµ', '·ä†·ã≤·àµ_·ä†·â†·â£_·ã©·äí·â®·à≠·à≤·â≤', '·à≥·ã≠·äï·àµ', '·â¥·ä≠·äñ·àé·åÇ',
      '·ã®·ä¢·âµ·ãÆ·åµ·ã´_·àµ·çñ·à≠·âµ', '·ä•·åç·à≠_·ä≥·àµ', '·àò·àÆ·å•', '·ä¶·àä·àù·çí·ä≠'
    ];
  }

  async initialize() {
    console.log('üöÄ Initializing Simple Amharic Article Collector...');
    
    try {
      await fs.mkdir(this.outputDir, { recursive: true });
      console.log(`üìÅ Created output directory: ${this.outputDir}`);
    } catch (error) {
      console.log(`üìÅ Output directory already exists: ${this.outputDir}`);
    }
  }

  async fetchUrl(url) {
    return new Promise((resolve, reject) => {
      const client = url.startsWith('https:') ? https : http;
      
      const req = client.get(url, {
        headers: {
          'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
          'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
          'Accept-Language': 'am,en;q=0.9'
        }
      }, (res) => {
        let data = '';
        
        res.on('data', (chunk) => {
          data += chunk;
        });
        
        res.on('end', () => {
          resolve(data);
        });
      });
      
      req.on('error', (error) => {
        reject(error);
      });
      
      req.setTimeout(10000, () => {
        req.destroy();
        reject(new Error('Request timeout'));
      });
    });
  }

  async fetchWikipediaArticle(title) {
    const url = `https://am.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
    
    try {
      const response = await this.fetchUrl(url);
      const data = JSON.parse(response);
      
      if (data.extract && data.extract.length > 100) {
        return {
          title: data.title || title,
          content: data.extract,
          url: `https://am.wikipedia.org/wiki/${encodeURIComponent(title)}`,
          source: 'Wikipedia Amharic',
          timestamp: new Date().toISOString()
        };
      }
      
      return null;
    } catch (error) {
      console.log(`‚ùå Failed to fetch ${title}: ${error.message}`);
      return null;
    }
  }

  async fetchWikipediaFullArticle(title) {
    const url = `https://am.wikipedia.org/w/api.php?action=query&format=json&titles=${encodeURIComponent(title)}&prop=extracts&exintro=false&explaintext=true`;
    
    try {
      const response = await this.fetchUrl(url);
      const data = JSON.parse(response);
      
      const pages = data.query?.pages;
      if (pages) {
        const pageId = Object.keys(pages)[0];
        const page = pages[pageId];
        
        if (page.extract && page.extract.length > 500) {
          return {
            title: page.title || title,
            content: page.extract,
            url: `https://am.wikipedia.org/wiki/${encodeURIComponent(title)}`,
            source: 'Wikipedia Amharic',
            timestamp: new Date().toISOString(),
            wordCount: page.extract.split(/\s+/).length
          };
        }
      }
      
      return null;
    } catch (error) {
      console.log(`‚ùå Failed to fetch full article ${title}: ${error.message}`);
      return null;
    }
  }

  isAmharicContent(text) {
    if (!text) return false;
    
    const amharicRegex = /[\u1200-\u137F]/g;
    const amharicChars = (text.match(amharicRegex) || []).length;
    const totalChars = text.length;
    
    return amharicChars > 0 && (amharicChars / totalChars) > 0.3;
  }

  async saveArticle(article, index) {
    const filename = `article_${index.toString().padStart(4, '0')}.json`;
    const filepath = path.join(this.outputDir, filename);
    
    try {
      await fs.writeFile(filepath, JSON.stringify(article, null, 2), 'utf8');
      console.log(`‚úÖ [${index}/${this.maxArticles}] Saved: ${article.title.substring(0, 60)}...`);
      return true;
    } catch (error) {
      console.error(`‚ùå Error saving article ${index}:`, error.message);
      return false;
    }
  }

  async collectFromWikipedia() {
    console.log('\nüìö Collecting from Wikipedia Amharic...');
    
    for (const title of this.wikiArticles) {
      if (this.currentCount >= this.maxArticles) break;
      
      console.log(`\nüîç Fetching: ${title}`);
      
      // Try full article first
      let article = await this.fetchWikipediaFullArticle(title);
      
      // If that fails, try summary
      if (!article) {
        article = await this.fetchWikipediaArticle(title);
      }
      
      if (article && this.isAmharicContent(article.content)) {
        article.articleNumber = this.currentCount + 1;
        
        const saved = await this.saveArticle(article, this.currentCount + 1);
        if (saved) {
          this.articles.push(article);
          this.currentCount++;
        }
      } else {
        console.log(`‚ùå Skipped: Invalid or non-Amharic content`);
      }
      
      // Be respectful to Wikipedia
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
  }

  async discoverMoreWikipediaArticles() {
    console.log('\nüîç Discovering more Wikipedia articles...');
    
    const categoryUrl = 'https://am.wikipedia.org/w/api.php?action=query&format=json&list=categorymembers&cmtitle=Category:·ä¢·âµ·ãÆ·åµ·ã´&cmlimit=50';
    
    try {
      const response = await this.fetchUrl(categoryUrl);
      const data = JSON.parse(response);
      
      const members = data.query?.categorymembers || [];
      console.log(`Found ${members.length} additional articles in Ethiopia category`);
      
      for (const member of members) {
        if (this.currentCount >= this.maxArticles) break;
        
        const title = member.title;
        if (!this.wikiArticles.includes(title)) {
          console.log(`\nüîç Fetching discovered article: ${title}`);
          
          const article = await this.fetchWikipediaFullArticle(title);
          
          if (article && this.isAmharicContent(article.content) && article.content.length > 500) {
            article.articleNumber = this.currentCount + 1;
            
            const saved = await this.saveArticle(article, this.currentCount + 1);
            if (saved) {
              this.articles.push(article);
              this.currentCount++;
            }
          }
          
          await new Promise(resolve => setTimeout(resolve, 1500));
        }
      }
    } catch (error) {
      console.log(`‚ùå Failed to discover more articles: ${error.message}`);
    }
  }

  async generateSyntheticVariations() {
    console.log('\nüîÑ Generating variations from existing articles...');
    
    const baseArticles = [...this.articles];
    
    for (const baseArticle of baseArticles) {
      if (this.currentCount >= this.maxArticles) break;
      
      // Create variations by extracting different sections
      const sentences = baseArticle.content.split(/[·ç¢·ç°]/).filter(s => s.trim().length > 50);
      
      if (sentences.length >= 5) {
        // Create focused articles from sections
        const sections = [];
        for (let i = 0; i < sentences.length; i += 3) {
          const section = sentences.slice(i, i + 3).join('·ç¢ ') + '·ç¢';
          if (section.length > 200) {
            sections.push(section);
          }
        }
        
        for (const section of sections) {
          if (this.currentCount >= this.maxArticles) break;
          
          const variation = {
            title: `${baseArticle.title} - ·ä≠·çç·àç ${sections.indexOf(section) + 1}`,
            content: section,
            url: `${baseArticle.url}#section_${sections.indexOf(section) + 1}`,
            source: `${baseArticle.source} (Section)`,
            timestamp: new Date().toISOString(),
            originalArticle: baseArticle.title,
            articleNumber: this.currentCount + 1
          };
          
          if (this.isAmharicContent(variation.content)) {
            const saved = await this.saveArticle(variation, this.currentCount + 1);
            if (saved) {
              this.articles.push(variation);
              this.currentCount++;
            }
          }
        }
      }
    }
  }

  async saveCollectionSummary() {
    const summary = {
      totalArticles: this.currentCount,
      collectionDate: new Date().toISOString(),
      sources: [...new Set(this.articles.map(a => a.source))],
      averageLength: Math.round(this.articles.reduce((sum, a) => sum + a.content.length, 0) / this.articles.length),
      totalCharacters: this.articles.reduce((sum, a) => sum + a.content.length, 0),
      articles: this.articles.map(a => ({
        title: a.title,
        source: a.source,
        length: a.content.length,
        url: a.url
      }))
    };
    
    const summaryPath = path.join(this.outputDir, 'collection_summary.json');
    await fs.writeFile(summaryPath, JSON.stringify(summary, null, 2), 'utf8');
    console.log(`\nüìã Collection summary saved to: ${summaryPath}`);
    
    return summary;
  }

  async run() {
    try {
      await this.initialize();
      
      console.log(`\nüéØ Target: ${this.maxArticles} Amharic articles`);
      
      // Collect from known good sources
      await this.collectFromWikipedia();
      console.log(`\nüìä Progress: ${this.currentCount}/${this.maxArticles} articles collected`);
      
      // Discover more articles
      if (this.currentCount < this.maxArticles) {
        await this.discoverMoreWikipediaArticles();
        console.log(`\nüìä Progress: ${this.currentCount}/${this.maxArticles} articles collected`);
      }
      
      // Generate variations to reach target
      if (this.currentCount < this.maxArticles) {
        await this.generateSyntheticVariations();
        console.log(`\nüìä Progress: ${this.currentCount}/${this.maxArticles} articles collected`);
      }
      
      const summary = await this.saveCollectionSummary();
      
      console.log(`\nüéâ Collection Complete!`);
      console.log(`üìä Final Statistics:`);
      console.log(`   Articles collected: ${summary.totalArticles}`);
      console.log(`   Total characters: ${summary.totalCharacters.toLocaleString()}`);
      console.log(`   Average length: ${summary.averageLength} characters`);
      console.log(`   Sources: ${summary.sources.join(', ')}`);
      console.log(`   Files saved in: ${this.outputDir}`);
      
    } catch (error) {
      console.error('‚ùå Collection failed:', error);
    }
  }
}

// Run if called directly
if (require.main === module) {
  const collector = new SimpleAmharicCollector();
  collector.run().catch(console.error);
}

module.exports = SimpleAmharicCollector;